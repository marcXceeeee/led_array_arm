#ifdef __USE_CMSIS
#include "LPC17xx.h"
#endif
#include <cr_section_macros.h>
#include <NXP/crp.h>
#include <ucos_ii.h>
#include <string.h>
#include "common.h"

#include "scan.h"

pixel_t fb[NUM_FRAME_BFRS][NUM_ROWS][NUM_COLS] __attribute__((aligned(8)));
pixel_t (*fb_ptr)[NUM_ROWS][NUM_COLS] = &fb[0];
pixel_t (*fb_back_ptr)[NUM_ROWS][NUM_COLS] = &fb[1];

#if (PWM_LEVELS == 64)
static const uint8_t lookup[] =
{
    0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2,
    2, 3, 3, 4, 4, 4, 5, 5, 6, 7, 7, 8, 9, 9, 10, 11,
    12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 23, 24, 25, 27, 28, 30,
    32, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 54, 56, 58, 61, 63
};
#elif (PWM_LEVELS == 256)
static const uint8_t lookup[] =
{
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2,
    2, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 7,
    7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 10, 10, 10, 11, 11, 11, 12, 12, 12, 13,
    13, 13, 14, 14, 14, 15, 15, 16, 16, 16, 17, 17, 18, 18, 19, 19, 20, 20,
    21, 21, 22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 28, 28, 29, 29, 30,
    31, 31, 32, 33, 33, 34, 35, 35, 36, 37, 37, 38, 39, 40, 40, 41, 42, 43,
    44, 44, 45, 46, 47, 48, 49, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59,
    60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 75, 76, 77, 78,
    79, 80, 82, 83, 84, 85, 87, 88, 89, 90, 92, 93, 94, 96, 97, 99, 100,
    101, 103, 104, 106, 107, 108, 110, 111, 113, 114, 116, 118, 119, 121,
    122, 124, 125, 127, 129, 130, 132, 134, 135, 137, 139, 141, 142, 144,
    146, 148, 149, 151, 153, 155, 157, 159, 161, 162, 164, 166, 168, 170,
    172, 174, 176, 178, 180, 182, 185, 187, 189, 191, 193, 195, 197, 200,
    202, 204, 206, 208, 211, 213, 215, 218, 220, 222, 225, 227, 230, 232,
    234, 237, 239, 242, 244, 247, 249, 252, 255,
};
#endif

#if (0)
static const uint32_t pic_10_bmp[] =
{
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x001e090a,
    0x001e090a, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x001e090a, 0x00270c0e, 0x001e090a, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x001e090a, 0x001e090a, 0x001e090a, 0x001e090a, 0x003f3f3f,
    0x003f3f3f, 0x001e090a, 0x00270c0e, 0x001e090a, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x001e090a, 0x00270c0e, 0x00270c0e,
    0x001e090a, 0x003f3f3f, 0x001e090a, 0x00270c0e, 0x001e090a, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x001e090a, 0x00270c0e, 0x00270c0e, 0x001e090a, 0x00270c0e, 0x001e090a, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x001e090a, 0x001e090a, 0x00270c0e, 0x001e090a,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x00121212, 0x00322d26, 0x00143433,
    0x001e090a, 0x00270c0e, 0x001e090a, 0x001e090a, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x00121212, 0x00322d26,
    0x00302822, 0x00322d26, 0x001e090a, 0x00270c0e, 0x00270c0e, 0x001e090a, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x00121212,
    0x00322d26, 0x00302822, 0x00322d26, 0x00121212, 0x003f3f3f, 0x001e090a, 0x00270c0e,
    0x001e090a, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x00121212, 0x00322d26, 0x00302822, 0x00322d26, 0x00121212, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x001e090a, 0x001e090a, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x00121212, 0x00322d26, 0x00302822, 0x00322d26, 0x00121212, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x00121212, 0x00322d26, 0x00302822, 0x00322d26, 0x00121212,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x00121212, 0x00322d26, 0x00302822, 0x00322d26,
    0x00121212, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x00121212, 0x00322d26, 0x00302822,
    0x00322d26, 0x00121212, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x00121212,
    0x00302822, 0x00322d26, 0x00121212, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x00121212, 0x00121212, 0x00121212, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f,
    0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f, 0x003f3f3f
};
#elif (0)// bow
static const uint32_t pic_10_bmp[] =
{
    0x00000000, 0x002a013f, 0x002a013f,
    0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f,
    0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x002a013f, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x002a013f, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x002a013f, 0x002a013f,
    0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f,
    0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x00000000, 0x002a013f, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x002a013f,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x002a013f, 0x002a013f, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x002a013f, 0x00000000, 0x002a013f, 0x002a013f, 0x002a013f,
    0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f,
    0x002a013f, 0x002a013f, 0x002a013f, 0x002a013f, 0x00000000
};
#else
static const uint32_t pic_10_bmp[] =
{
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x007a2729, 0x007a2729,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x007a2729, 0x009d323b, 0x007a2729, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x007a2729, 0x007a2729,
    0x007a2729, 0x007a2729, 0x00ffffff, 0x00ffffff, 0x007a2729, 0x009d323b,
    0x007a2729, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x007a2729, 0x009d323b, 0x009d323b, 0x007a2729,
    0x00ffffff, 0x007a2729, 0x009d323b, 0x007a2729, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x007a2729, 0x009d323b, 0x009d323b, 0x007a2729, 0x009d323b,
    0x007a2729, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x007a2729, 0x007a2729, 0x009d323b, 0x007a2729, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00494949, 0x00c8b49b, 0x0050d0cd,
    0x007a2729, 0x009d323b, 0x007a2729, 0x007a2729, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00494949, 0x00c8b49b, 0x00c0a18a, 0x00c8b49b, 0x007a2729, 0x009d323b,
    0x009d323b, 0x007a2729, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00494949, 0x00c8b49b, 0x00c0a18a,
    0x00c8b49b, 0x00494949, 0x00ffffff, 0x007a2729, 0x009d323b, 0x007a2729,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00494949, 0x00c8b49b, 0x00c0a18a, 0x00c8b49b, 0x00494949, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x007a2729, 0x007a2729, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00494949, 0x00c8b49b, 0x00c0a18a,
    0x00c8b49b, 0x00494949, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00494949, 0x00c8b49b, 0x00c0a18a, 0x00c8b49b, 0x00494949, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00494949, 0x00c8b49b, 0x00c0a18a,
    0x00c8b49b, 0x00494949, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00494949, 0x00c8b49b, 0x00c0a18a, 0x00c8b49b, 0x00494949, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00494949, 0x00c0a18a,
    0x00c8b49b, 0x00494949, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00494949, 0x00494949, 0x00494949, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff, 0x00ffffff,
    0x00ffffff, 0x00ffffff
};
#endif

static volatile int32_t fb_flip_waiting;
static volatile uint32_t row_time;
static volatile uint32_t total_time;
static volatile int32_t screen_state;
static uint8_t stage[NUM_COLS];

static void scan_set_screen_state(int32_t enable)
{
    register const port_t tmp = { .bits.oe = 1 };

    if (enable)
    {
        screen_state = 1;
        LPC_GPIO2 ->FIOCLR = tmp.all;
    }
    else
    {
        screen_state = 0;
        LPC_GPIO2 ->FIOSET = tmp.all;
    }
}

static void scan_fb_flip(void)
{
    pixel_t (*tmp)[NUM_ROWS][NUM_COLS] = fb_ptr;
    fb_ptr = fb_back_ptr;
    fb_back_ptr = tmp;
}

/**
 * Synchronization routine for the double-buffered frame buffer.
 *
 * User may either:
 *     - Notify scan engine that a new frame is ready (task-sensitive - may pend!).
 *     - Complete a FB flip upon completion of a scan sequence.
 *     - Forcibly perform an FB flip without synchronization.
 */
static int32_t scan_fb_flip_ctrl(fb_flip_control_t i)
{
    int32_t status = 0;
    uint8_t pend_stat;

    switch (i)
    {
        case FB_FLIP_ANIMATE_DONE:
        {
            /* Animator is done */
            fb_flip_waiting = 1;
            while (fb_flip_waiting)
            {
                /* Wait around until the scan engine picks up the frame */
                OSFlagPend(grp, FLAG_PENDING_STATE_CHG,
                           OS_FLAG_WAIT_SET_ANY + OS_FLAG_CONSUME, 0, &pend_stat);
            }
            break;
        }
        case FB_FLIP_SCAN_DONE:
        {
            if (fb_flip_waiting)
            {
                scan_fb_flip();
                fb_flip_waiting = 0;
                OSFlagPost(grp, FLAG_PENDING_STATE_CHG, OS_FLAG_SET, &pend_stat);
            }
            break;
        }
        case FB_FLIP_FORCE:
        {
            __disable_irq();
            scan_fb_flip();
            __enable_irq();
            break;
        }
        default:
            break;
    }

    return status;
}

/* a.k.a. vblank handler */
void TIMER0_IRQHandler(void)
{
    LPC_TIM0->IR = 1;               /* clear interrupt flag */
    scan_set_screen_state(0);       /* turn screen off */
    LPC_TIM0->MCR = 0;              /* turn timer off */
    LPC_TIM0->TCR |= 0x2;           /* reset timer */
    scan_fb_flip_ctrl(FB_FLIP_SCAN_DONE);
}

static inline void scan_select_row(int32_t phys_row)
{
    register port_t tmp = { .all = LPC_GPIO2 ->FIOPIN };

    tmp.bits.row = phys_row;
    LPC_GPIO2->FIOPIN = tmp.all;
}

static inline void scan_latch_data(void)
{
    register const port_t tmp = { .bits.lat = 1 };

    LPC_GPIO2->FIOSET = tmp.all;
    LPC_GPIO2->FIOCLR = tmp.all;
}

static inline void scan_clk_out(void)
{
    register const port_t tmp = { .bits.clk = 1 };

    LPC_GPIO2->FIOSET = tmp.all;
    LPC_GPIO2->FIOCLR = tmp.all;
}

/**
 * Arms the one-shot incrementing counter to interrupt when count == t.
 * Intended to be used for signaling the start of the VBLANK interval.
 */
static void scan_vblank_arm(uint32_t t)
{
    LPC_TIM0->MR0 = t;              /* match reg */
    LPC_TIM0->TC = 0;               /* reset counter - counts up*/
    LPC_TIM0->MCR = 3;              /* Interrupt and Reset on MR0 */
    NVIC_EnableIRQ(TIMER0_IRQn);
    LPC_TIM0->TCR = 1;
}

__attribute__ ((__section__(".data.ramfunc"))) /* saves 300 ticks! */
#define _BAM(x,y) (  ((x) & (1 << (y))) >> (y)      )
static void scan_write_row(int32_t row, uint32_t pwm, uint32_t i)
{
    const uint32_t t_start = DWT_CYCCNT;

    /* Pre-process pixel states for the entire row */
    if (i)
    {
        for (int32_t col = 0; col < NUM_COLS; col++)
        {
            register const pixel_t px0 = (*fb_ptr)[row][col];
            register const pixel_t px1 = (*fb_ptr)[row + INTERLEAVE_FACTOR][col];

            /* Enable pixel if current PWM cycle is less than pixel magnitude */
            stage[col] = (_BAM(lookup[px1.bits.b],pwm) << 5)
                         | (_BAM(lookup[px1.bits.g],pwm) << 4)
                         | (_BAM(lookup[px1.bits.r],pwm) << 3)
                         | (_BAM(lookup[px0.bits.b],pwm) << 2)
                         | (_BAM(lookup[px0.bits.g],pwm) << 1)
                         | (_BAM(lookup[px0.bits.r],pwm) << 0);
        }
    }

    /* Clock out pre-computed pixel states */
    for (int32_t col = 0; col < NUM_COLS; col++)
    {
        port_t tmp;

#if (1)
        /* Read-Modify-Write */
        tmp.all = LPC_GPIO2->FIOPIN;
        tmp.fasterbits.rgb0_1 = stage[col];
        LPC_GPIO2 ->FIOPIN = tmp.all;
#else
        /* Would it be any faster to use the SET/CLR registers? */
#endif

        /* Blip the pixel clock */
        scan_clk_out();
    }

    /* Refresh display */
    scan_set_screen_state(0);
    scan_select_row(row);
    scan_latch_data();
    scan_set_screen_state(1);

    row_time = DWT_CYCCNT - t_start;
}

/**
 * LED array PWM scanning routine
 */
static void scan_main(void)
{
    const uint32_t t_start = DWT_CYCCNT;

    for (int32_t row = 0; row < NUM_SCAN_ROWS; row++)
    {
        for (uint32_t pwm = 0; pwm < WIDTH_RED; pwm++)
        {
            /* assume all colors have same width */
            int32_t i = BIT(pwm);
            do
            {
                scan_write_row(row, pwm, (i == BIT(pwm)));
            } while (--i != 0);
        }
    }

    /*
     * The LED array is strobed during each successive row update. To ensure
     * that the last row isn't brighter than the others, we need turn the
     * display OFF after it has been on for a row's worth of update time.
     */
    scan_vblank_arm(row_time);

    total_time = DWT_CYCCNT - t_start;
}

static void animate_scroll(int32_t dir, int32_t shift, int32_t alpha)
{
    //__disable_irq();

    for (int32_t row = 0; row < NUM_ROWS; row++)
    {
        for (int32_t col = 0; col < NUM_COLS; col++)
        {
            const int32_t shifted_col = (col - shift) & (NUM_COLS - 1);

            (*fb_back_ptr)[row][col].all = pic_10_bmp[shifted_col * NUM_ROWS
                                           + row];

            if ((*fb_back_ptr)[row][col].all != 0)
            {
                if ((*fb_back_ptr)[row][col].bits.r < (PX_MAX_VAL - alpha))
                    (*fb_back_ptr)[row][col].bits.r += alpha;
                else
                    (*fb_back_ptr)[row][col].bits.r = PX_MAX_VAL;

                if ((*fb_back_ptr)[row][col].bits.g < (PX_MAX_VAL - alpha))
                    (*fb_back_ptr)[row][col].bits.g += alpha;
                else
                    (*fb_back_ptr)[row][col].bits.g = PX_MAX_VAL;

                if ((*fb_back_ptr)[row][col].bits.b < (PX_MAX_VAL - alpha))
                    (*fb_back_ptr)[row][col].bits.b += alpha;
                else
                    (*fb_back_ptr)[row][col].bits.b = PX_MAX_VAL;
            }
        }
    }

    //__enable_irq();
}

int32_t task_scan(void)
{
    for (;;)
    {
        scan_main();
        scan_set_screen_state(0);
        while (screen_state == 1);
        OSTimeDly(task_scan_hz);
    }
}

int32_t task_animate(void)
{
    int32_t shift = 0;
    int32_t alpha = 0;
    int32_t alpha_dir = 1;
    int32_t alpha_iter = 50;

    for (;;)
    {
        animate_scroll(0, shift--, alpha);

        /* Request a FB flip */
        scan_fb_flip_ctrl(FB_FLIP_ANIMATE_DONE);

        if (alpha_iter-- == 0)
        {
            alpha_iter = 5;
            if (alpha_dir)
            {
                if (++alpha == PX_MAX_VAL)
                    alpha_dir = 0;
            }
            else
            {
                if (--alpha == 0)
                    alpha_dir = 1;
            }
        }

        OSTimeDly(task_animate_hz);
    }
}

void init_scan(void)
{
    for (int32_t i = 0; i < NUM_FRAME_BFRS; i++)
    {
        for (int32_t row = 0; row < NUM_ROWS; row++)
        {
            for (int32_t col = 0; col < NUM_COLS; col++)
            {
                (*fb_ptr)[row][col].all = pic_10_bmp[col * NUM_ROWS + row];
            }
        }

        scan_fb_flip_ctrl(FB_FLIP_FORCE);
    }
}
